@using DNSLab.Web.DTOs.Repositories.Record
@using DNSLab.Web.Enums
@attribute [Route(AllRoutes.RecordsHistory)]
@attribute [Authorize]
<SeoProvider Title="تاریخچه تغییرات رکورد های دامنه" />

<MudCard Elevation="0">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h5">تاریخچه تغییرات</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            @if ((_IsSubscribeThisFeature != null && _IsSubscribeThisFeature == true) || RecordId is null)
            {
                <BaseButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Primary" EndIcon="@DNSLabIcons.Refresh" OnClick="OnInitializedAsync">بروزرسانی</BaseButton>
            }
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (_IsSubscribeThisFeature != null || RecordId is null)
        {
            @if (RecordId is not null)
            {
                <MudOverlay Visible="_IsSubscribeThisFeature == false" DarkBackground="true" LockScroll Absolute="true" Style="height:100vh">
                    <MudContainer>
                        <MudText Color="MudBlazor.Color.Warning">اشتراک فعلی شما این قابلیت را پوشش نمیدهد لطفا اشتراک تهیه فرمایید</MudText>
                        <MudButton Variant="Variant.Filled" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Primary" EndIcon="@DNSLabIcons.Subscriptions" Href="@AllRoutes.Bundle">تهیه اشتراک</MudButton>
                    </MudContainer>
                </MudOverlay>
                <MudAlert Class="mb-2" Dense Severity="Severity.Info" Variant="Variant.Outlined" ContentAlignment="HorizontalAlignment.Start">
                    <MudText Typo="Typo.body2">در این بخش تاریخچه تغییرات رکورد ها نمایش داده میشود</MudText>
                    <MudText Typo="Typo.body2">
                        در صورت اعمال روی سرور ها با علامت
                        <MudChip T="string" Icon="@DNSLabIcons.Check" Size="Size.Small" Color="Color.Success" Label="true">اعمال شده</MudChip>
                        و در صورتی که در حال انجام باشد با علامت
                        <MudChip T="string" Icon="@DNSLabIcons.Refresh" Size="Size.Small" Color="Color.Info" Label="true">در حال اعمال</MudChip>
                        مشخص میگردد
                    </MudText>
                </MudAlert>
            }
            @if (_IsSubscribeThisFeature == true || RecordId is null)
            {
                <MudDataGrid T="RecordChangeDTO" Items="_RecordChanges?.OrderByDescending(x=>x.TimeStamp)" Loading="_Loading" Dense Hover Outlined>
                    <NoRecordsContent>
                        <NoRecordFound />
                    </NoRecordsContent>
                    <Columns>
                        <PropertyColumn Property="x=>x.TimeStamp.ToLocalTime().ToPersianDateTime()" Title="زمان" />
                        <PropertyColumn Property="x=>x.OperationId" Title="عملیات">
                            <CellTemplate>
                                @switch ((RecordChangeOperationEnum)context.Item.OperationId)
                                {
                                    case RecordChangeOperationEnum.Insert:
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small" Label="true">ثبت</MudChip>
                                        break;
                                    case RecordChangeOperationEnum.Delete:
                                        <MudChip T="string" Color="Color.Error" Size="Size.Small" Label="true">حذف</MudChip>
                                        break;
                                    case RecordChangeOperationEnum.Update:
                                        <MudChip T="string" Color="Color.Info" Size="Size.Small" Label="true">ویرایش</MudChip>
                                        break;
                                    case RecordChangeOperationEnum.Disable:
                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small" Label="true">فعالیت</MudChip>
                                        break;
                                }
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x=>x.PreviousData" Title="قبل" CellClass="dnslab-ltr" Sortable="false">
                            <CellTemplate>
                                @if (context.Item.PreviousData is not null)
                                {
                                    <MudText Typo="Typo.caption">
                                        <text>Name : @(context.Item.PreviousData.Name)</text>
                                        <MudFlexBreak />
                                        @switch (context.Item.PreviousData.Type)
                                        {
                                            case Enums.RecordTypeEnum.A:
                                                <text>IPv4 : @(context.Item.PreviousData.CastTo<ARecordDTO>()!.IPv4Address)</text>
                                                break;
                                            case Enums.RecordTypeEnum.AAAA:
                                                <text>IPv6 : @(context.Item.PreviousData.CastTo<AAAARecordDTO>()!.IPv6Address)</text>
                                                break;
                                            case Enums.RecordTypeEnum.TXT:
                                                <text>Text Data : @(context.Item.PreviousData.CastTo<TXTRecordDTO>()!.TextData)</text>
                                                break;
                                            case Enums.RecordTypeEnum.MX:
                                                <text>Exchange : @(context.Item.PreviousData.CastTo<MXRecordDTO>()!.Exchange)</text>
                                                <MudFlexBreak />
                                                <text>Preference : @(context.Item.PreviousData.CastTo<MXRecordDTO>()!.Preference)</text>
                                                break;
                                            case Enums.RecordTypeEnum.CNAME:
                                                <text>CName : @(context.Item.PreviousData.CastTo<CNAMERecordDTO>()!.CName)</text>
                                                break;
                                            default:
                                                break;
                                        }
                                        <MudFlexBreak />
                                        TTL : @context.Item.PreviousData.TTL
                                    </MudText>
                                }
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x=>x.CurrentData" Title="بعد" CellClass="dnslab-ltr" Sortable="false">
                            <CellTemplate>
                                @if (context.Item.CurrentData is not null)
                                {
                                    <MudText Typo="Typo.caption">
                                        <text>Name : @(context.Item.CurrentData.Name)</text>
                                        <MudFlexBreak />
                                        @switch (context.Item.CurrentData.Type)
                                        {
                                            case Enums.RecordTypeEnum.A:
                                                <text>IPv4 : @(context.Item.CurrentData.CastTo<ARecordDTO>()!.IPv4Address)</text>
                                                break;
                                            case Enums.RecordTypeEnum.AAAA:
                                                <text>IPv6 : @(context.Item.CurrentData.CastTo<AAAARecordDTO>()!.IPv6Address)</text>
                                                break;
                                            case Enums.RecordTypeEnum.TXT:
                                                <text>Text Data : @(context.Item.CurrentData.CastTo<TXTRecordDTO>()!.TextData)</text>
                                                break;
                                            case Enums.RecordTypeEnum.MX:
                                                <text>Exchange : @(context.Item.CurrentData.CastTo<MXRecordDTO>()!.Exchange)</text>
                                                <MudFlexBreak />
                                                <text>Preference : @(context.Item.CurrentData.CastTo<MXRecordDTO>()!.Preference)</text>
                                                break;
                                            case Enums.RecordTypeEnum.CNAME:
                                                <text>CName : @(context.Item.CurrentData.CastTo<CNAMERecordDTO>()!.CName)</text>
                                                break;
                                            default:
                                                break;
                                        }
                                        <MudFlexBreak />
                                        TTL : @context.Item.CurrentData.TTL
                                    </MudText>
                                }
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x=>x.IsProcessed" Title="وضعیت">
                            <CellTemplate>
                                @if (context.Item.IsProcessed)
                                {
                                    <MudChip T="string" Icon="@DNSLabIcons.Check" Size="Size.Small" Color="Color.Success" Label="true">اعمال شده</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Icon="@DNSLabIcons.Refresh" Size="Size.Small" Color="Color.Info" Label="true">در حال اعمال</MudChip>
                                }
                            </CellTemplate>
                        </PropertyColumn>
                    </Columns>
                </MudDataGrid>
            }
        }
    </MudCardContent>
</MudCard>
