@using DNSLab.Web.DTOs.Repositories.Page
@using DNSLab.Web.Interfaces.Repositories
@inject IHttpContextAccessor httpContextAccessor;
@inject IPageRepository _PageRepository;

<MudDrawer @bind-Open="_drawerOpen" Overlay="true" Elevation="0" ClipMode="DrawerClipMode.Always">
    <MudPaper Class="mb-2 pa-3" Elevation="0">
        <MudLink Href="@AllRoutes.Home" Underline="Underline.None" Color="Color.Inherit">
            <MudStack Spacing="0" AlignItems="AlignItems.Center" Row Justify="Justify.SpaceAround">
                <MudImage Src="images/Logo.png" Width="43" Fluid />
                <MudStack AlignItems="AlignItems.Center" Spacing="0">
                    <MudText Typo="Typo.h5">@GlobalSettings.ApplicationName</MudText>
                    <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-n2">@GlobalSettings.Version</MudText>
                </MudStack>
            </MudStack>
        </MudLink>
    </MudPaper>
    <AuthorizeView Context="_AuthCTX">
        <Authorized>
            <MudNavMenu Dense>
                <MudNavLink Href="@AllRoutes.Dashboard" Match="NavLinkMatch.All" Icon="@DNSLabIcons.Dashboard">داشبورد</MudNavLink>
                @if (_AuthCTX.User.IsInRole(AuthorizeRoles.Admin))
                {
                    <MudNavGroup Title="مدیریت" Icon="@DNSLabIcons.Management">
                        <MudNavLink Href="@AllRoutes.AllTickets">تیکت ها</MudNavLink>
                        <MudNavLink Href="@AllRoutes.AllPages">مطالب سایت</MudNavLink>
                        <MudNavLink Href="@AllRoutes.TodayChangesDDNS">تغییرات DDNS امروز</MudNavLink>
                        <MudNavLink Href="@AllRoutes.RecordsHistory">تغییرات رکورد های امروز</MudNavLink>
                        <MudNavLink Href="@AllRoutes.AllPayments">همه پرداخت ها</MudNavLink>
                        <MudNavLink Href="@AllRoutes.AllBundles">اشتراک‌ها</MudNavLink>
                    </MudNavGroup>
                }
                <MudNavLink Icon="@DNSLabIcons.Domain" Href="@AllRoutes.AllZones">دامنه‌ ها</MudNavLink>
                <MudNavGroup Title="Dynamic DNS" Icon="@DNSLabIcons.DNS">
                    <MudNavLink Href="@AllRoutes.DDNSHostNames" Icon="@DNSLabIcons.NetworkNodes">هاست‌نیم ها</MudNavLink>
                    <MudNavLink Href="@AllRoutes.UpdateTokens" Icon="@DNSLabIcons.Key">کلید ها</MudNavLink>
                    <MudNavLink Href="@AllRoutes.RouterSettings" Icon="@DNSLabIcons.Router">تنظیمات مودم (روتر)</MudNavLink>
                    <MudNavLink Href="@AllRoutes.MikroTikSettings" Icon="@DNSLabIcons.Mikrotik">تنظیمات MikroTik</MudNavLink>
                    <MudNavLink Href="@AllRoutes.RaspberryPiSettings" Icon="@DNSLabIcons.RaspberryPi">تنظیمات Raspberry Pi</MudNavLink>
                </MudNavGroup>
                <MudNavGroup Title="Reverse Proxy" Icon="@DNSLabIcons.NAT">
                    <MudNavLink Icon="@DNSLabIcons.Download" Href="@AllRoutes.SetupAndInstallation">راه‌اندازی و نصب</MudNavLink>
                    <MudNavLink Icon="@DNSLabIcons.Key" Href="@AllRoutes.AuthToken">توکن احراز هویت شما</MudNavLink>
                    <MudNavGroup Title="Tunnels" Icon="@DNSLabIcons.Tunnels">
                        <MudNavLink Icon="@DNSLabIcons.Tunnel" Href="@AllRoutes.HttpReverseProxy">HTTP</MudNavLink>
                        <MudNavLink Icon="@DNSLabIcons.Tunnel" Href="@AllRoutes.TcpReverseProxy">TCP</MudNavLink>
                        <MudNavLink Icon="@DNSLabIcons.Tunnel" Href="@AllRoutes.UdpReverseProxy">UDP</MudNavLink>
                    </MudNavGroup>
                    @* <MudNavLink Icon="@DNSLabIcons.ActiveTunnels" Href="@AllRoutes.ActiveTunnels">تونل های فعال</MudNavLink> *@
                </MudNavGroup>
                <MudNavGroup Title="کیف پول" Icon="@DNSLabIcons.Wallet">
                    <MudNavLink Href="@AllRoutes.MyWallet">موجودی</MudNavLink>
                    <MudNavLink Href="@AllRoutes.WalletTransactions">تراکنش ها</MudNavLink>
                    <MudNavLink Href="@AllRoutes.Payments">پرداخت ها</MudNavLink>
                </MudNavGroup>
                <MudNavLink Href="@AllRoutes.Monitoring" Icon="@DNSLabIcons.Monitoring">مانیتورینگ</MudNavLink>
                <MudNavGroup Title="اشتراک" Icon="@DNSLabIcons.Premium">
                    <MudNavLink Href="@AllRoutes.MyBundles">اشتراک‌ها</MudNavLink>
                    <MudNavLink Href="@AllRoutes.Renewal">تمدید اشتراک</MudNavLink>
                </MudNavGroup>
            </MudNavMenu>
            <MudSpacer />
        </Authorized>
    </AuthorizeView>
    <MudNavMenu Dense>
        <MudNavLink Icon="@DNSLabIcons.Subscriptions" Href="@AllRoutes.Bundle">تهیه اشتراک</MudNavLink>
        <MudNavLink Icon="@DNSLabIcons.Tools" Href="@AllRoutes.AllTools">ابزار ها</MudNavLink>
        <MudNavLink Icon="@DNSLabIcons.Support" Href="@AllRoutes.MyTickets">پشتیبانی</MudNavLink>
        <MudNavGroup Icon="@DNSLabIcons.Wiki" Title="Wiki">
            @if (_WikiMenu is not null)
            {
                @foreach (var menu in _WikiMenu.SubMenus)
                {
                    @RenderMenu(menu)
                }
            }
        </MudNavGroup>
        <MudNavLink Icon="@DNSLabIcons.Blog" Href="@AllRoutes.AllBlogs">بلاگ</MudNavLink>
        <MudNavLink Icon="@DNSLabIcons.Contribute" Href="@AllRoutes.Contribute">مشارکت در توسعه</MudNavLink>
        <MudNavLink Icon="@DNSLabIcons.Info" Href="@AllRoutes.About">درباره ما</MudNavLink>
        <AuthorizeView>
            <Authorized>
                <MudNavLink Href="@AllRoutes.MyAccount" Icon="@DNSLabIcons.ManageAccount">حساب کاربری</MudNavLink>
                <MudNavLink Href="@AllRoutes.Logout" Icon="@DNSLabIcons.Logout" IconColor="Color.Error">خروج</MudNavLink>
            </Authorized>
        </AuthorizeView>
    </MudNavMenu>
</MudDrawer>

@code {
    private bool _drawerOpen = true;
    public void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
        StateHasChanged();
    }

    IEnumerable<PageInfoDTO>? _WikiPages { get; set; } = Enumerable.Empty<PageInfoDTO>();

    WikiMenuItem? _WikiMenu { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _WikiPages = await _PageRepository.GetPagesByType(Shared.Enums.PageTypeEnum.Wiki);

        if (_WikiPages is not null && _WikiPages.Any())
        {
            var root = new WikiMenuItem { Title = "Wiki", URL = "/" };

            foreach (var page in _WikiPages)
            {
                var parts = page.URL.Trim('/').Split('/');
                AddPageRecursive(root, parts, 0, page.URL, page.Title);
            }

            _WikiMenu = root;
        }
    }


    private void AddPageRecursive(WikiMenuItem parent, string[] parts, int index, string fullPath, string title)
    {
        if (index >= parts.Length)
            return;

        // Build the path up to this part
        string path = string.Join("/", parts.Take(index + 1)).Insert(0, "/");

        // Find or create the child
        var child = parent.SubMenus.FirstOrDefault(c => c.URL == path);
        if (child == null)
        {
            child = new WikiMenuItem
                {
                    Title = _WikiPages.FirstOrDefault(x => x.URL.Trim('/') == path.Trim('/'))?.Title ?? String.Empty, // leaf gets page title
                    URL = path
                };
            parent.SubMenus.Add(child);
        }

        // Recurse into the next level
        AddPageRecursive(child, parts, index + 1, fullPath, title);
    }

    private RenderFragment RenderMenu(WikiMenuItem menu) => builder =>
    {
        if (menu.SubMenus?.Any() == true)
        {
            // Render as a NavGroup if it has children
            builder.OpenComponent<MudNavGroup>(0);
            builder.AddAttribute(1, "Title", menu.Title);
            builder.AddAttribute(2, "ChildContent", (RenderFragment)(childBuilder =>
            {
                foreach (var sub in menu.SubMenus)
                {
                    childBuilder.AddContent(3, RenderMenu(sub));
                }
            }));
            builder.CloseComponent();
        }
        else
        {
            // Render as a NavLink if it has no children
            builder.OpenComponent<MudNavLink>(4);
            builder.AddAttribute(5, "Href", "/wiki" + menu.URL);
            builder.AddAttribute(6, "Match", NavLinkMatch.All);
            builder.AddAttribute(7, "ChildContent", (RenderFragment)(childBuilder =>
            {
                childBuilder.AddContent(8, menu.Title);
            }));
            builder.CloseComponent();
        }
    };

    class WikiMenuItem
    {
        public Guid Id { get; set; }
        public string URL { get; set; }
        public string Title { get; set; }

        public List<WikiMenuItem> SubMenus { get; set; } = new();
    }
}